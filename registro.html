<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Registro</title>
    <link rel="stylesheet" href="stylesec.css">
    <script defer src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <header>
            <h2 class="modalTitle">Preencha o formulário</h2>
        </header>

            <form action="#" id="myForm">
                <div class="inputFieldContainer">
                    <div class="personalInfo column">
                        <h3>Dados Pessoais</h3>
                        <div class="form_control">
                            <label for="name">Nome completo:</label>
                            <input type="text" id="name" name="name" placeholder="Digite o nome" 
                            maxlength="75"
                            required oninvalid="this.setCustomValidity('É necessário informar seu nome completo.')" onchange="try{setCustomValidity('')}catch(e){}">
                        </div>
                        <div class="form_control">
                            <label for="genero">Gênero:</label>
                            <select id="genero" name="genero" required oninvalid="this.setCustomValidity('É necessário informar um gênero.')" onchange="try{setCustomValidity('')}catch(e){}">
                                <option value="">Selecione um gênero</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Feminino">Feminino</option>
                                <option value="Outro">Outro</option>
                            </select>      
                        </div>
                        <div class="form_control">
                            <label for="cpf">CPF:</label>
                            <input type="text" id="cpf" name="cpf" placeholder="Digite o CPF (apenas números)" pattern="\d{11}" required oninvalid="this.setCustomValidity('É necessário informar um CPF.')" onchange="try{setCustomValidity('')}catch(e){}">
                        </div>
                        <div class="form_control">
                            <label for="sDate">Data de Nascimento:</label>
                            <input type="date" id="sDate" min="1924-01-01" max="" required oninvalid="this.setCustomValidity('Cadastro permitido apenas para maiores de 13 anos.')" onchange="try{setCustomValidity('')}catch(e){}">
                        </div>
                        <div class="form_control">
                            <label for="email">Email:</label>
                            <input type="email" id="email" placeholder="Digite o email" 
                            maxlength="155"
                            required oninvalid="this.setCustomValidity('É necessário informar um e-mail válido.')" onchange="try{setCustomValidity('')}catch(e){}">
                        </div>
                        <div class="form_control">
                            <label for="phone">Telefone celular:</label>
                            <input type="tel" name="phone" id="phone" minlength="8" maxlength="11" placeholder="O telefone deve possuir entre 8 a 11 digitos" required oninvalid="this.setCustomValidity('É necessário informar um número completo.')" onchange="try{setCustomValidity('')}catch(e){}">
                        </div>
                        <div class="regPassword">
                            <div class="form_control">
                                <label for="password">Senha:</label>
                                <input type="password" id="password" name="password" placeholder="Digite sua senha" required>
                            </div>
                            <div id="confpasswordContainer" class="form_control">
                                <label for="confpassword">Confirme sua senha:</label>
                                <input type="password" id="confpassword" name="confpassword" placeholder="Confirme sua senha" required>
                            </div>
                        </div>
                    </div>

                    <div class="addressInfo column">
                        <h3>Endereço</h3>
                        <div class="form_control">
                            <label for="typeAddress">Tipo de Endereço:</label>
                            <select id="typeAddress" name="typeAddress" 
                            required oninvalid="this.setCustomValidity('É necessário informar o tipo de endereço')" onchange="try{setCustomValidity('')}catch(e){}">
                                <option value="">Selecione um tipo de endereço</option>
                                    <option value="bill">Cobrança</option>
                                    <option value="delivery">Entrega</option>
                            </select>
                        </div>
                        <div class="form_control">
                            <label for="estado">Estado:</label>
                            <select id="estado" name="estado" 
                            required oninvalid="this.setCustomValidity('É necessário informar um Estado')" onchange="try{setCustomValidity('')}catch(e){}">
                                    <option value="">Selecione um estado</option>
                                    <option value="AC">Acre</option>
                                    <option value="AL">Alagoas</option>
                                    <option value="AP">Amapá</option>
                                    <option value="AM">Amazonas</option>
                                    <option value="BA">Bahia</option>
                                    <option value="CE">Ceará</option>
                                    <option value="DF">Distrito Federal</option>
                                    <option value="ES">Espírito Santo</option>
                                    <option value="GO">Goiás</option>
                                    <option value="MA">Maranhão</option>
                                    <option value="MT">Mato Grosso</option>
                                    <option value="MS">Mato Grosso do Sul</option>
                                    <option value="MG">Minas Gerais</option>
                                    <option value="PA">Pará</option>
                                    <option value="PB">Paraíba</option>
                                    <option value="PR">Paraná</option>
                                    <option value="PE">Pernambuco</option>
                                    <option value="PI">Piauí</option>
                                    <option value="RJ">Rio de Janeiro</option>
                                    <option value="RN">Rio Grande do Norte</option>
                                    <option value="RS">Rio Grande do Sul</option>
                                    <option value="RO">Rondônia</option>
                                    <option value="RR">Roraima</option>
                                    <option value="SC">Santa Catarina</option>
                                    <option value="SP">São Paulo</option>
                                    <option value="SE">Sergipe</option>
                                    <option value="TO">Tocantins</option>
                            </select>
                        </div>
                        <div class="form_control">
                            <label for="city">Cidade:</label>
                            <input type="text" id="city" name="city" placeholder="Digite a cidade" 
                            maxlength="75"
                            required oninvalid="this.setCustomValidity('É necessário informar uma cidade.')" onchange="try{setCustomValidity('')}catch(e){}">
                        </div>
                        <div class="form_control">
                            <label for="cep">CEP:</label>
                            <input type="text" id="cep" name="cep" pattern="\d{8}" placeholder="Digite o CEP (apenas números)" required oninvalid="this.setCustomValidity('É necessário informar um CEP.')" onchange="try{setCustomValidity('')}catch(e){}">
                        </div>
                        <div class="form_control">
                            <label for="neighborhood">Bairro:</label>
                            <input type="text" id="neighborhood" name="neighborhood" placeholder="Digite o seu bairro" 
                            maxlength="75"
                            required oninvalid="this.setCustomValidity('É necessário informar um bairro.')" onchange="try{setCustomValidity('')}catch(e){}">
                        </div>
                        <div class="form_control">
                            <label for="street">Rua:</label>
                            <input type="text" id="street" name="street" placeholder="Digite o nome da sua rua" 
                            maxlength="75"
                            required oninvalid="this.setCustomValidity('É necessário informar uma rua.')" onchange="try{setCustomValidity('')}catch(e){}">
                        </div>
                        <div class="form_control">
                            <label for="houseNumber">Número:</label>
                            <input type="text" id="houseNumber" name="houseNumber" placeholder="Digite o número da sua residência"
                            required pattern="\d{1,10}" maxlength="10" 
                            required oninvalid="this.setCustomValidity('É necessário informar um número de resiência.')" onchange="try{setCustomValidity('')}catch(e){}">
                        </div>
                        
                        
                    </div>
                    
                    <div class="payment-info column">
                        <h3>Método de Pagamento</h3>
                        <div class="form_control">
                            <label for="typeCard">Tipo de Cartão:</label>
                            <select id="typeCard" name="typeCard" 
                            required oninvalid="this.setCustomValidity('É necessário informar o tipo de cartão')" onchange="try{setCustomValidity('')}catch(e){}">
                                    <option value="">Selecione um tipo de cartão</option>
                                    <option value="credit">Crédito</option>
                                    <option value="debit">Debito</option>
                            </select>
                            <div class="form_control">
                                <label for="flagCard">Bandeira do Cartão:</label>
                                <select id="flagCard" name="flagCard" 
                                required oninvalid="this.setCustomValidity('É necessário informar a bandeira do cartão')" onchange="try{setCustomValidity('')}catch(e){}">
                                        <option value="">Selecione a bandeira do cartão</option>
                                        <option value="visa">Visa</option>
                                        <option value="mastercard">Mastercard</option>
                                        <option value="elo">Elo</option>
                                        <option value="discover">Discover</option>
                                        <option value="americanExpress">American Express</option>
                                        <option value="hipercard">Hipercard</option>
                                </select>
                        <div class="form_control">
                            <label for="cardName">Nome no Cartão:</label>
                            <input type="text" id="cardName" name="cardName" placeholder="Digite o nome do proprietario do cartão" 
                            required oninvalid="this.setCustomValidity('É necessário informar o nome do proprietario do cartão.')" onchange="try{setCustomValidity('')}catch(e){}">
                        </div>
                        <div class="form_control">
                            <label for="cardNumber">Número do Cartão:</label>
                            <input type="text" id="cardNumber" name="cardNumber" placeholder="Digite o número do cartão com 16 digitos" 
                            pattern="\d{16}"
                            required oninvalid="this.setCustomValidity('É necessário informar o número do cartão.')" onchange="try{setCustomValidity('')}catch(e){}">
                        </div>
                        <div class="form_control">
                            <label for="expiryDate">Data de Validade:</label>
                            <input type="month" id="expiryDate" name="expiryDate" placeholder="Digite a data de validade do cartão" 
                            required oninvalid="this.setCustomValidity('É necessário informar a data de validade do cartão.')" onchange="try{setCustomValidity('')}catch(e){}">
                        </div>
                        <div class="form_control">
                            <label for="cvv">CVV:</label>
                            <input type="text" id="cvv" name="cvv" placeholder="Digite o código de segurança do cartão"
                            pattern="\d{3}" maxlength="3" 
                            required oninvalid="this.setCustomValidity('É necessário informar o código de segurança do cartão.')" onchange="try{setCustomValidity('')}catch(e){}">
                            <footer class="popupFooter">
                                <button form="myForm" class="submitBtn">Enviar</button>
                            </footer> 
                        </div> 
                    </div>
                </div>
            </form>
        </div>
        

         
    </div>
    <script>
            let originalData = localStorage.getItem('userProfile') ? JSON.parse(localStorage.getItem('userProfile')) : [];

            document.getElementById('cardNumber').addEventListener('input', function() {
    let cardNumber = this.value.replace(/\s+/g, '');
    
    // Limitar a entrada a 16 dígitos
    if (cardNumber.length > 16) {
        cardNumber = cardNumber.slice(0, 16);
        this.value = cardNumber;  // Atualiza o valor do campo de entrada
    }

    const typeCard = document.getElementById('typeCard');
    const flagCard = document.getElementById('flagCard');

    // Função para determinar a bandeira do cartão
    function getCardType(number) {
        const regexes = {
            visa: /^4[0-9]{12}(?:[0-9]{3})?$/,
            mastercard: /^5[1-5][0-9]{14}$/,
            amex: /^3[47][0-9]{13}$/,
            discover: /^6(?:011|5[0-9]{2})[0-9]{12}$/,
            elo: /^(4011|4312|4389|4514|4576|5041|5066|5090|6277|6363|6362|6500|6504|6505|6506|6507|6509|6516|6550|6552)[0-9]{12,15}$/,
            hipercard: /^(606282|3841)[0-9]{10,13}$/,
        };

        for (const [flag, pattern] of Object.entries(regexes)) {
            if (pattern.test(number)) {
                return flag;
            }
        }
        return '';
    }

    // Definir a bandeira do cartão
    const cardType = getCardType(cardNumber);

    if (cardType) {
        flagCard.value = cardType;
        typeCard.value = ['visa', 'mastercard', 'elo', 'discover', 'amex', 'hipercard'].includes(cardType) ? 'credit' : 'debit';
    } else {
        flagCard.value = '';
        typeCard.value = '';
    }
});


            //Limita a data de expiração do cartão
            const expiryDateInput = document.getElementById('expiryDate');
            const today = new Date();
            const year = today.getFullYear();
            const month = ('0' + (today.getMonth() + 1)).slice(-2); // Formata o mês com dois dígitos

            expiryDateInput.min = `${year}-${month}`;


            // Regex para validar a senha
            const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\W).{8,}$/;

            const hoje = new Date();  
            const anoAtras = hoje.getFullYear() - 13;  
            const mesHoje = hoje.getMonth() + 1;  
            const diaHoje = hoje.getDate();  
            const dataMaxima = anoAtras + '-' + (mesHoje < 10 ? '0' + mesHoje : mesHoje) + '-' + (diaHoje < 10 ? '0' + diaHoje : diaHoje);  
            document.getElementById('sDate').setAttribute('max', dataMaxima);

            function isCPFUnique(cpf) {
                return !originalData.some((user) => user.cpf === cpf);
            }

            function validarCPF(cpf) {
                cpf = cpf.replace(/[^\d]+/g, ''); // Remove qualquer coisa que não seja número

                if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) {
                    return false; // CPF inválido se todos os números forem iguais
                }

                let soma = 0;
                let resto;

                // Validação do primeiro dígito verificador
                for (let i = 1; i <= 9; i++) {
                    soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
                }

                resto = (soma * 10) % 11;
                if (resto === 10 || resto === 11) resto = 0;
                if (resto !== parseInt(cpf.substring(9, 10))) {
                    return false;
                }

                soma = 0;
                // Validação do segundo dígito verificador
                for (let i = 1; i <= 10; i++) {
                    soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
                }

                resto = (soma * 10) % 11;
                if (resto === 10 || resto === 11) resto = 0;
                if (resto !== parseInt(cpf.substring(10, 11))) {
                    return false;
                }

                return true;
            }

            document.getElementById('myForm').addEventListener('submit', function(event) {
            event.preventDefault();

            //Verifica se o CPF e valido
            const cpfVal = cpf.value.trim();
            if (!validarCPF(cpfVal)) {
                alert('CPF inválido. Por favor, insira um CPF válido.');
                return;
            }
            //Verifica se o cpf ja foi cadastrado
            const cpfValue = cpf.value.trim();

            if (!isCPFUnique(cpfValue)) {
                alert("Este CPF já está cadastrado.");
                return;
            }
            //Validacoes de senha 
            const password = document.getElementById('password').value.trim();
            const confPassword = document.getElementById('confpassword').value.trim();
            
           
             //Verifica se a senha e forte
            if (!regex.test(password)) {
                alert('A senha deve conter no mínimo 8 caracteres, sendo pelo menos uma letra maiúscula, uma letra minúscula e um caractere especial.');
                return;
            }
             // Verifica se as senhas coincidem
            if (password !== confPassword) {
                alert('As senhas não coincidem. Por favor, verifique.');
                return;
            }
            
            const formData = {
                name: document.getElementById('name').value,
                genero: document.getElementById('genero').value,
                cpf: document.getElementById('cpf').value,
                nascimento: document.getElementById('sDate').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                password: document.getElementById('password').value,
                confpassword: document.getElementById('confpassword').value,
                typeAddress: document.getElementById('typeAddress').value,
                estado: document.getElementById('estado').value,
                city: document.getElementById('city').value,
                cep: document.getElementById('cep').value,
                neighborhood: document.getElementById('neighborhood').value,
                street: document.getElementById('street').value,
                houseNumber: document.getElementById('houseNumber').value,
                typeCard: document.getElementById('typeCard').value,
                flagCard: document.getElementById('flagCard').value,
                cardName: document.getElementById('cardName').value,
                cardNumber: document.getElementById('cardNumber').value,
                expiryDate: document.getElementById('expiryDate').value,
                cvv: document.getElementById('cvv').value
            };
    
            let userProfile = localStorage.getItem('userProfile') ? JSON.parse(localStorage.getItem('userProfile')) : [];
            userProfile.push(formData);
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
    
            window.location.href = 'index.html'; // Redirect to index.html
        });
    </script>
</body>
</html>